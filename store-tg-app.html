<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Demo Store</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "SF Pro Text", "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      --surface-border-color: rgba(31, 35, 48, 0.08);
      --card-border-color: rgba(31, 35, 48, 0.08);
      --button-active-color: #1555aa;
      --danger-surface-color: rgba(234, 84, 90, 0.08);
      --danger-border-color: rgba(234, 84, 90, 0.25);
      --toast-bg-color: rgba(17, 24, 35, 0.92);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--tg-theme-bg-color, #f5f6f8);
      color: var(--tg-theme-text-color, #1f2330);
      font-family: inherit;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .page {
      max-width: 420px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    .status {
      padding: 12px 14px;
      border-radius: 12px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border: 1px solid var(--surface-border-color, rgba(31, 35, 48, 0.08));
      color: var(--tg-theme-hint-color, #5f6471);
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }

    .status strong {
      color: var(--tg-theme-text-color, #1f2330);
    }

    .status.error {
      background-color: var(--danger-surface-color, rgba(234, 84, 90, 0.08));
      border-color: var(--danger-border-color, rgba(234, 84, 90, 0.25));
      color: var(--tg-theme-destructive-text-color, #c7363c);
    }

    .products {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border: 1px solid var(--card-border-color, rgba(31, 35, 48, 0.08));
    }

    .card-info {
      flex: 1;
      min-width: 0;
    }

    .card-info h2 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .card-info p {
      margin: 0;
      font-size: 13px;
      color: var(--tg-theme-hint-color, #5f6471);
    }

    .card-info .price {
      margin-top: 10px;
      font-weight: 600;
      font-size: 14px;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .quantity {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity button {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: none;
      background-color: var(--tg-theme-button-color, #1a68d1);
      color: var(--tg-theme-button-text-color, #ffffff);
      font-size: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease, opacity 0.15s ease;
      touch-action: manipulation;
    }

    .quantity button:disabled {
      opacity: 0.35;
      cursor: default;
    }

    .quantity button:not(:disabled):active {
      background-color: var(--button-active-color, #1555aa);
    }

    .quantity-value {
      min-width: 26px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .summary {
      padding: 14px 16px;
      border-radius: 14px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border: 1px solid var(--surface-border-color, rgba(31, 35, 48, 0.08));
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .submit {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background-color: var(--tg-theme-button-color, #1a68d1);
      color: var(--tg-theme-button-text-color, #ffffff);
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .submit:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      padding: 14px 20px;
      border-radius: 14px;
      background: var(--toast-bg-color, rgba(17, 24, 35, 0.92));
      color: var(--tg-theme-button-text-color, #ffffff);
      box-shadow: 0 8px 24px rgba(9, 17, 33, 0.28);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
      font-size: 13px;
    }

    .toast.visible {
      opacity: 0.94;
    }

    button:focus-visible {
      outline: 2px solid var(--tg-theme-link-color, #1a68d1);
      outline-offset: 2px;
    }

    [v-cloak] {
      display: none;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --surface-border-color: rgba(255, 255, 255, 0.04);
        --card-border-color: rgba(255, 255, 255, 0.04);
        --button-active-color: #416fda;
        --danger-surface-color: rgba(255, 156, 162, 0.12);
        --danger-border-color: rgba(255, 156, 162, 0.32);
        --toast-bg-color: rgba(8, 13, 23, 0.92);
      }
    }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    <main class="page">
      <h1>My Telegram Store</h1>
      <div id="status" class="status" :class="{ error: statusIsError }">{{ statusText }}</div>

      <section class="products">
        <article class="card" v-for="product in products" :key="product.id">
          <div class="card-info">
            <h2>{{ product.name }}</h2>
            <p>{{ product.description }}</p>
            <div class="price">{{ product.price }} ₴</div>
          </div>
          <div class="quantity">
            <button
              type="button"
              class="qty-button"
              data-role="minus"
              :aria-label="'Decrease quantity for ' + product.name"
              :disabled="quantities[product.id] === 0"
              @click="decrement(product.id)"
            >−</button>
            <span class="quantity-value">{{ quantities[product.id] }}</span>
            <button
              type="button"
              class="qty-button"
              data-role="plus"
              :aria-label="'Increase quantity for ' + product.name"
              @click="increment(product.id)"
            >+</button>
          </div>
        </article>
      </section>

      <div class="summary">
        <span>Total</span>
        <span>{{ totalAmount }} ₴</span>
      </div>

      <button
        v-if="showLocalButton"
        class="submit"
        type="button"
        :disabled="isSubmitDisabled"
        @click="submitOrder"
      >
        {{ submitButtonLabel }}
      </button>

      <section v-if="debugMode" class="status error">
        {{ debugText || "DEBUG MODE: API logs will appear below." }}
      </section>
    </main>

    <div class="toast" role="status" v-if="toastVisible">{{ toastMessage }}</div>
  </div>

  <script>
    (function() {
      const ORDER_ENDPOINT = "https://api.sendpulse.com/events/id/230b72780acd4255ecb438b57968e5f6/264992";
      const urlParams = new URLSearchParams(window.location.search);
      const contactIdParam = urlParams.get('contact_id') || '';
      const debugModeParam = urlParams.get('debug') === '1';

      new Vue({
        el: '#app',
        data() {
          const products = [
            { id: 'pizza_margherita', name: 'Pizza Margherita', description: 'Tomato sauce, mozzarella, basil', price: 220 },
            { id: 'pizza_pepperoni', name: 'Pizza Pepperoni', description: 'Salami, tomato sauce, cheese', price: 260 },
            { id: 'burger_classic', name: 'Classic Burger', description: 'Beef patty, cheddar cheese, bacon', price: 210 }
          ];
          const quantities = {};
          products.forEach(product => {
            quantities[product.id] = 0;
          });
          return {
            products,
            quantities,
            contactId: contactIdParam,
            debugMode: debugModeParam,
            showLocalButton: true,
            submitting: false,
            statusMessage: '',
            statusIsError: !contactIdParam,
            debugLogs: [],
            toastMessage: '',
            toastVisible: false,
            tg: null,
            toastTimer: null
          };
        },
        computed: {
          statusText() {
            if (!this.contactId) {
              return 'contact_id is missing in the URL parameters. Check the bot button configuration.';
            }
            return `Subscriber: ${this.contactId}${this.statusMessage ? '\\n' + this.statusMessage : ''}`;
          },
          totalAmount() {
            return this.products.reduce((sum, product) => sum + this.quantities[product.id] * product.price, 0);
          },
          hasItems() {
            return this.products.some(product => this.quantities[product.id] > 0);
          },
          isSubmitDisabled() {
            return !this.contactId || this.submitting || !this.hasItems;
          },
          submitButtonLabel() {
            return this.submitting ? 'Sending...' : 'Submit Order';
          },
          debugText() {
            return this.debugLogs.join('\\n\\n');
          }
        },
        mounted() {
          this.tg = window.Telegram?.WebApp || null;
          if (this.tg) {
            this.initTelegram();
            this.showLocalButton = false;
          }
          this.updateMainButton();
        },
        methods: {
          increment(productId) {
            this.quantities[productId] += 1;
            this.updateMainButton();
          },
          decrement(productId) {
            if (this.quantities[productId] === 0) return;
            this.quantities[productId] -= 1;
            this.updateMainButton();
          },
          updateMainButton() {
            if (!this.tg) return;
            const ready = !this.isSubmitDisabled;
            if (!ready) {
              this.tg.MainButton.hideProgress?.();
              this.tg.MainButton.hide();
              return;
            }
            const params = this.tg.themeParams || {};
            const computedStyle = getComputedStyle(document.documentElement);
            this.tg.MainButton.setParams({
              text: this.submitButtonLabel,
              color: params.button_color || computedStyle.getPropertyValue('--tg-theme-button-color') || '#1a68d1',
              text_color: params.button_text_color || computedStyle.getPropertyValue('--tg-theme-button-text-color') || '#ffffff'
            });
            if (this.submitting) {
              this.tg.MainButton.showProgress?.();
            } else {
              this.tg.MainButton.hideProgress?.();
            }
            this.tg.MainButton.show();
          },
          logDebug(message) {
            if (!this.debugMode) return;
            const time = new Date().toLocaleTimeString();
            this.debugLogs.push(`[${time}] ${message}`);
          },
          showToast(message) {
            this.toastMessage = message;
            this.toastVisible = true;
            clearTimeout(this.toastTimer);
            this.toastTimer = setTimeout(() => {
              this.toastVisible = false;
            }, 2600);
          },
          async submitOrder() {
            if (this.isSubmitDisabled) return;

            this.submitting = true;
            this.updateMainButton();
            this.logDebug('Preparing payload for submission');

            const items = this.products
              .filter(product => this.quantities[product.id] > 0)
              .map(product => ({
                id: product.id,
                name: product.name,
                quantity: this.quantities[product.id],
                price: product.price,
                subtotal: this.quantities[product.id] * product.price
              }));

            const payload = {
              chatbots_subscriber_id: this.contactId,
              order_items: items,
              total_amount: this.totalAmount,
              currency: 'UAH',
              created_at: new Date().toISOString(),
              source: 'telegram_web_app',
              notes: 'Demo order'
            };

            this.logDebug(
              [
                `POST ${ORDER_ENDPOINT}`,
                'Headers:',
                JSON.stringify({ 'Content-Type': 'application/json' }, null, 2),
                'Payload:',
                JSON.stringify(payload, null, 2)
              ].join('\\n')
            );

            try {
              const response = await fetch(ORDER_ENDPOINT, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                const bodyText = await response.text();
                throw new Error(`API error: ${response.status} ${response.statusText || ''} — ${bodyText}`);
              }

              this.logDebug('API response: success');
              this.statusMessage = 'Order submitted successfully ✅';
              this.statusIsError = false;
              this.showToast('Order submitted ✅');
              if (this.tg) {
                this.tg.HapticFeedback?.notificationOccurred?.('success');
              }
              this.resetOrder();
              if (this.tg && !this.debugMode) {
                this.tg.MainButton.hideProgress?.();
                this.tg.MainButton.hide();
                setTimeout(() => {
                  try {
                    this.tg.close();
                  } catch (error) {
                    this.logDebug('Failed to close WebApp: ' + error);
                  }
                }, 600);
              }
            } catch (error) {
              console.error(error);
              this.logDebug('Error: ' + (error && error.message ? error.message : error));
              this.statusMessage = 'Failed to submit the order. ' + (error && error.message ? error.message : '');
              this.statusIsError = true;
              this.showToast('Failed to submit the order');
              if (this.tg) {
                this.tg.HapticFeedback?.notificationOccurred?.('error');
              }
            } finally {
              this.submitting = false;
              this.updateMainButton();
            }
          },
          resetOrder() {
            Object.keys(this.quantities).forEach(productId => {
              this.quantities[productId] = 0;
            });
          },
          initTelegram() {
            const tg = this.tg;
            tg.ready();
            tg.expand?.();

            const applyTheme = () => {
              const root = document.documentElement;
              const params = tg.themeParams || {};
              const map = {
                bg_color: '--tg-theme-bg-color',
                text_color: '--tg-theme-text-color',
                hint_color: '--tg-theme-hint-color',
                link_color: '--tg-theme-link-color',
                button_color: '--tg-theme-button-color',
                button_text_color: '--tg-theme-button-text-color',
                secondary_bg_color: '--tg-theme-secondary-bg-color',
                destructive_text_color: '--tg-theme-destructive-text-color'
              };
              Object.entries(map).forEach(([key, cssVar]) => {
                if (params[key]) {
                  root.style.setProperty(cssVar, params[key]);
                }
              });
            };

            applyTheme();
            tg.onEvent?.('themeChanged', applyTheme);
            tg.MainButton.setText(this.submitButtonLabel);
            tg.MainButton.onClick(() => this.submitOrder());
          }
        },
        watch: {
          quantities: {
            deep: true,
            handler() {
              this.updateMainButton();
            }
          },
          submitting() {
            this.updateMainButton();
          }
        }
      });
    })();
  </script>
</body>
</html>
