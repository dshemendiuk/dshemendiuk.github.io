<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Магазин</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      --tg-theme-bg-color: #f4f5f7;
      --tg-theme-text-color: #1f2330;
      --tg-theme-link-color: #1a68d1;
      --tg-theme-button-color: #1a68d1;
      --tg-theme-button-color-dark: #0f45a4;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f8f9fb;
      --tg-theme-hint-color: #5d6473;
      --tg-theme-destructive-text-color: #ab1f2b;
      --tg-card-bg-color: #ffffff;
      --tg-card-border-color: #d9dde5;
      --tg-card-shadow: 0 4px 20px rgba(15, 30, 60, 0.08);
      --tg-status-border-color: rgba(26, 104, 209, 0.25);
      --tg-status-error-bg: rgba(171, 31, 43, 0.12);
      --tg-status-error-border: rgba(171, 31, 43, 0.3);
      --tg-toast-bg-color: #1a2330;
    }

    body {
      margin: 0;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-family: inherit;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
      padding: 24px 20px 40px;
    }

    h1 {
      margin: 0 0 24px;
      font-size: 24px;
      text-align: center;
    }

    .status {
      margin-bottom: 20px;
      padding: 12px 16px;
      border-radius: 12px;
      background-color: var(--tg-theme-secondary-bg-color);
      color: var(--tg-theme-link-color);
      border: 1px solid var(--tg-status-border-color);
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }

    .status.error {
      background-color: var(--tg-status-error-bg);
      color: var(--tg-theme-destructive-text-color);
      border-color: var(--tg-status-error-border);
    }

    .products {
      display: grid;
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--tg-card-border-color);
      background-color: var(--tg-card-bg-color);
      box-shadow: var(--tg-card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: var(--tg-theme-hint-color);
    }

    .card .price {
      font-weight: 600;
      color: var(--tg-theme-text-color);
    }

    .quantity {
      display: grid;
      grid-template-columns: repeat(3, 40px);
      gap: 4px;
      align-items: center;
    }

    .quantity button {
      border: none;
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border-radius: 10px;
      font-size: 20px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .quantity button:disabled {
      background-color: rgba(26, 104, 209, 0.35);
      cursor: not-allowed;
    }

    .quantity button:hover:not(:disabled) {
      background-color: var(--tg-theme-button-color-dark);
    }

    .quantity input {
      width: 40px;
      text-align: center;
      border-radius: 10px;
      border: 1px solid #cfd6e3;
      padding: 8px;
      font-size: 16px;
    }

    .summary {
      margin-bottom: 24px;
      padding: 16px;
      border-radius: 14px;
      background: var(--tg-theme-secondary-bg-color);
      border: 1px solid var(--tg-card-border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      font-weight: 600;
    }

    .submit {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      color: var(--tg-theme-button-text-color);
      background: linear-gradient(135deg, var(--tg-theme-button-color), var(--tg-theme-button-color-dark));
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }

    .submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .submit:active:not(:disabled) {
      transform: translateY(1px);
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 28px;
      transform: translateX(-50%);
      padding: 16px 24px;
      border-radius: 16px;
      background: var(--tg-toast-bg-color);
      color: var(--tg-theme-button-text-color);
      box-shadow: 0 8px 24px rgba(15, 30, 60, 0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
      font-size: 14px;
    }

    .toast.visible {
      opacity: 0.95;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --tg-theme-bg-color: #0f1218;
        --tg-theme-text-color: #f0f2f8;
        --tg-theme-link-color: #9fc5ff;
        --tg-theme-button-color: #518dff;
        --tg-theme-button-color-dark: #3b6dd6;
        --tg-theme-button-text-color: #f4f6fb;
        --tg-theme-secondary-bg-color: #151b26;
        --tg-theme-hint-color: #abb3c2;
        --tg-theme-destructive-text-color: #ff9ca2;
        --tg-card-bg-color: #151a23;
        --tg-card-border-color: #232a36;
        --tg-card-shadow: none;
        --tg-status-border-color: rgba(159, 197, 255, 0.25);
        --tg-status-error-bg: rgba(255, 156, 162, 0.12);
        --tg-status-error-border: rgba(255, 156, 162, 0.32);
        --tg-toast-bg-color: #0d1522;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <h1>Мій Телеграм-магазин</h1>
    <div id="status" class="status"></div>

    <section class="products" id="products"></section>
    <div class="summary">
      <span>До сплати</span>
      <span id="total">0 ₴</span>
    </div>
    <button id="submit" class="submit" type="button" disabled>Відправити замовлення</button>
    <section id="debug-panel" class="status error" hidden></section>
  </main>
  <div id="toast" class="toast" role="status"></div>

  <script>
    const PRODUCTS = [
      { id: "pizza_margherita", name: "Піца Маргарита", description: "Томатний соус, моцарела, базилік", price: 220 },
      { id: "pizza_pepperoni", name: "Піца Пепероні", description: "Салямі, томатний соус, сир", price: 260 },
      { id: "burger_classic", name: "Бургер Класичний", description: "Яловичина, сир чеддер, бекон", price: 210 },
      { id: "burger_veggie", name: "Бургер Veggie", description: "Фалафель, авокадо, мікс зелені", price: 190 }
    ];

    const ORDER_ENDPOINT = "https://api.sendpulse.com/events/id/230b72780acd4255ecb438b57968e5f6/264992";

    const statusEl = document.getElementById("status");
    const productsEl = document.getElementById("products");
    const totalEl = document.getElementById("total");
    const submitButton = document.getElementById("submit");
    const toastEl = document.getElementById("toast");
    const debugPanelEl = document.getElementById("debug-panel");
    const tg = window.Telegram?.WebApp || null;

    const urlParams = new URLSearchParams(window.location.search);
    const contactId = urlParams.get("contact_id");
    const debugMode = urlParams.get("debug") === "1";

    const themeState = {
      buttonColor: null,
      buttonTextColor: null
    };

    const state = {
      contactId,
      quantities: Object.fromEntries(PRODUCTS.map(product => [product.id, 0])),
      total: 0,
      submitting: false,
      statusMessage: "",
      statusIsError: false
    };

    setupTelegramExperience();

    function renderStatus() {
      if (!state.contactId) {
        statusEl.textContent = "contact_id не переданий у параметрах URL. Перевірте налаштування кнопки в боті.";
        statusEl.classList.add("error");
        submitButton.disabled = true;
        return;
      }

      const baseText = `Підписник: ${state.contactId}`;
      const extra = state.statusMessage ? `\n${state.statusMessage}` : "";
      statusEl.textContent = baseText + extra;
      statusEl.classList.toggle("error", state.statusIsError);
    }

    function renderProducts() {
      productsEl.innerHTML = "";

      PRODUCTS.forEach(product => {
        const card = document.createElement("article");
        card.className = "card";

        const info = document.createElement("div");
        info.innerHTML = `
          <h2>${product.name}</h2>
          <p>${product.description}</p>
          <p class="price">${product.price} ₴</p>
        `;

        const quantityControls = document.createElement("div");
        quantityControls.className = "quantity";

        const minusButton = document.createElement("button");
        minusButton.type = "button";
        minusButton.textContent = "−";
        minusButton.dataset.productId = product.id;
        minusButton.addEventListener("click", () => updateQuantity(product.id, state.quantities[product.id] - 1));

        const quantityInput = document.createElement("input");
        quantityInput.type = "number";
        quantityInput.min = "0";
        quantityInput.value = state.quantities[product.id];
        quantityInput.dataset.productId = product.id;
        quantityInput.addEventListener("change", (event) => {
          const value = Math.max(0, Number.parseInt(event.target.value, 10) || 0);
          updateQuantity(product.id, value);
        });

        const plusButton = document.createElement("button");
        plusButton.type = "button";
        plusButton.textContent = "+";
        plusButton.addEventListener("click", () => updateQuantity(product.id, state.quantities[product.id] + 1));

        quantityControls.appendChild(minusButton);
        quantityControls.appendChild(quantityInput);
        quantityControls.appendChild(plusButton);

        card.appendChild(info);
        card.appendChild(quantityControls);

        productsEl.appendChild(card);
      });
    }

    function updateQuantity(productId, nextValue) {
      const value = Math.max(0, nextValue);
      state.quantities[productId] = value;
      state.total = calculateTotal();
      renderTotals();
      updateSubmitState();
      syncInputs();
    }

    function calculateTotal() {
      return PRODUCTS.reduce((sum, product) => {
        return sum + state.quantities[product.id] * product.price;
      }, 0);
    }

    function renderTotals() {
      totalEl.textContent = `${state.total} ₴`;
    }

    function updateSubmitState() {
      const hasItems = PRODUCTS.some(product => state.quantities[product.id] > 0);
      const ready = hasItems && Boolean(state.contactId);
      const disabled = !ready || state.submitting;
      submitButton.disabled = disabled;

      if (tg) {
        if (!ready) {
          tg.MainButton.hideProgress?.();
          tg.MainButton.hide();
        } else {
          const { color, textColor } = getButtonColors();
          tg.MainButton.setParams({
            text: state.submitting ? "Відправка..." : "Відправити замовлення",
            color,
            text_color: textColor
          });
          if (state.submitting) {
            tg.MainButton.showProgress?.();
          } else {
            tg.MainButton.hideProgress?.();
          }
          tg.MainButton.show();
        }
      }
    }

    function syncInputs() {
      const inputs = productsEl.querySelectorAll("input[type='number'][data-product-id]");
      inputs.forEach(input => {
        const productId = input.dataset.productId;
        input.value = state.quantities[productId];
      });

      const minusButtons = productsEl.querySelectorAll(".quantity button[data-product-id]");
      minusButtons.forEach(button => {
        const productId = button.dataset.productId;
        button.disabled = state.quantities[productId] === 0;
      });
    }

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add("visible");
      setTimeout(() => toastEl.classList.remove("visible"), 2600);
    }

    async function submitOrder() {
      if (state.submitting) return;
      if (submitButton.disabled && !tg) return;

      state.submitting = true;
      updateSubmitState();
      if (tg) {
        tg.HapticFeedback?.impactOccurred?.("medium");
      }

      const items = PRODUCTS
        .filter(product => state.quantities[product.id] > 0)
        .map(product => ({
          id: product.id,
          name: product.name,
          quantity: state.quantities[product.id],
          price: product.price,
          subtotal: state.quantities[product.id] * product.price
        }));

      const payload = {
        chatbots_subscriber_id: state.contactId,
        order_items: items,
        total_amount: state.total,
        currency: "UAH",
        created_at: new Date().toISOString(),
        source: "telegram_web_app",
        notes: "Demo замовлення"
      };

      try {
        logDebug([
          "POST " + ORDER_ENDPOINT,
          "Headers:",
          JSON.stringify({
            "Content-Type": "application/json"
          }, null, 2),
          "Payload:",
          JSON.stringify(payload, null, 2)
        ].join("\n"));

        const response = await fetch(ORDER_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const bodyText = await response.text();
          throw new Error(`Помилка API: ${response.status} ${response.statusText || ""} — ${bodyText}`);
        }

        logDebug("Відповідь API: успіх");
        updateStatusMessage("Замовлення відправлено успішно ✅", false);
        showToast("Замовлення відправлено ✅");
        if (tg) {
          tg.HapticFeedback?.notificationOccurred?.("success");
        }
        resetOrder();
      } catch (error) {
        console.error(error);
        logDebug("Помилка: " + (error && error.message ? error.message : error));
        updateStatusMessage("Не вдалося відправити замовлення. " + (error && error.message ? error.message : ""), true);
        showToast("Не вдалося відправити замовлення");
        if (tg) {
          tg.HapticFeedback?.notificationOccurred?.("error");
        }
      } finally {
        state.submitting = false;
        updateSubmitState();
        if (tg && !state.submitting && !debugMode) {
          setTimeout(() => {
            if (PRODUCTS.every(product => state.quantities[product.id] === 0)) {
              tg.close();
            }
          }, 900);
        }
      }
    }

    function resetOrder() {
      PRODUCTS.forEach(product => {
        state.quantities[product.id] = 0;
      });
      state.total = 0;
      syncInputs();
      renderTotals();
    }

    submitButton.addEventListener("click", submitOrder);

    renderStatus();
    renderProducts();
    renderTotals();
    updateSubmitState();
    syncInputs();

    if (debugMode) {
      debugPanelEl.hidden = false;
      debugPanelEl.textContent = "DEBUG MODE: лог запитів з'явиться нижче.";
    }

    function logDebug(message) {
      if (!debugMode) return;
      const time = new Date().toLocaleTimeString();
      const existing = debugPanelEl.textContent ? debugPanelEl.textContent + "\n\n" : "";
      debugPanelEl.textContent = existing + `[${time}] ${message}`;
    }
    function logDebug(message) {
      if (!debugMode) return;
      const time = new Date().toLocaleTimeString();
      const existing = debugPanelEl.textContent ? debugPanelEl.textContent + "\n\n" : "";
      debugPanelEl.textContent = existing + `[${time}] ${message}`;
    }

    function updateStatusMessage(message, isError) {
      state.statusMessage = message;
      state.statusIsError = isError;
      renderStatus();
    }

    function setupTelegramExperience() {
      if (!tg) return;

      tg.ready();
      tg.expand?.();
      applyThemeParams(tg.themeParams || {});
      tg.onEvent?.("themeChanged", () => {
        applyThemeParams(tg.themeParams || {});
        updateSubmitState();
      });

      submitButton.style.display = "none";
      submitButton.setAttribute("aria-hidden", "true");
      submitButton.tabIndex = -1;

      tg.MainButton.setText("Відправити замовлення");
      tg.MainButton.onClick(submitOrder);
      tg.MainButton.hide();

      if (tg.colorScheme) {
        document.documentElement.style.colorScheme = tg.colorScheme;
      }

      logDebug("Telegram WebApp API доступний, нативні елементи активовано.");
    }

    function applyThemeParams(params) {
      const root = document.documentElement;
      const map = {
        bg_color: "--tg-theme-bg-color",
        text_color: "--tg-theme-text-color",
        hint_color: "--tg-theme-hint-color",
        link_color: "--tg-theme-link-color",
        button_color: "--tg-theme-button-color",
        button_text_color: "--tg-theme-button-text-color",
        secondary_bg_color: "--tg-theme-secondary-bg-color"
      };

      Object.entries(map).forEach(([key, cssVar]) => {
        if (params[key]) {
          root.style.setProperty(cssVar, params[key]);
        }
      });

      if (params.secondary_bg_color) {
        const darkerBorder = adjustColor(params.secondary_bg_color, -18);
        root.style.setProperty("--tg-card-bg-color", params.secondary_bg_color);
        if (darkerBorder) {
          root.style.setProperty("--tg-card-border-color", darkerBorder);
        }
      }

      if (params.bg_color) {
        const toastColor = adjustColor(params.bg_color, -35);
        if (toastColor) {
          root.style.setProperty("--tg-toast-bg-color", toastColor);
        }
      }

      const computed = getComputedStyle(root);
      themeState.buttonColor = (params.button_color || computed.getPropertyValue("--tg-theme-button-color")).trim();
      themeState.buttonTextColor = (params.button_text_color || computed.getPropertyValue("--tg-theme-button-text-color")).trim();

      const darker = adjustColor(themeState.buttonColor, -18);
      if (darker) {
        root.style.setProperty("--tg-theme-button-color-dark", darker);
      }
    }

    function getButtonColors() {
      const computed = getComputedStyle(document.documentElement);
      const color = (themeState.buttonColor || computed.getPropertyValue("--tg-theme-button-color") || "#1a68d1").trim();
      const textColor = (themeState.buttonTextColor || computed.getPropertyValue("--tg-theme-button-text-color") || "#ffffff").trim();
      return { color, textColor };
    }

    function adjustColor(hexColor, percent) {
      const hexMatch = /^#([0-9a-f]{6})$/i.exec(hexColor || "");
      if (!hexMatch) return null;
      const num = parseInt(hexMatch[1], 16);
      let r = (num >> 16) & 0xff;
      let g = (num >> 8) & 0xff;
      let b = num & 0xff;

      const factor = (100 + percent) / 100;
      r = Math.min(255, Math.max(0, Math.round(r * factor)));
      g = Math.min(255, Math.max(0, Math.round(g * factor)));
      b = Math.min(255, Math.max(0, Math.round(b * factor)));

      const toHex = value => value.toString(16).padStart(2, "0");
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
  </script>
</body>
</html>
