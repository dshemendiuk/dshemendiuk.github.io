<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Demo Магазин</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "SF Pro Text", "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      --surface-border-color: rgba(31, 35, 48, 0.08);
      --card-border-color: rgba(31, 35, 48, 0.08);
      --button-active-color: #1555aa;
      --danger-surface-color: rgba(234, 84, 90, 0.08);
      --danger-border-color: rgba(234, 84, 90, 0.25);
      --toast-bg-color: rgba(17, 24, 35, 0.92);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--tg-theme-bg-color, #f5f6f8);
      color: var(--tg-theme-text-color, #1f2330);
      font-family: inherit;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    .page {
      max-width: 420px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    .status {
      padding: 12px 14px;
      border-radius: 12px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border: 1px solid var(--surface-border-color, rgba(31, 35, 48, 0.08));
      color: var(--tg-theme-hint-color, #5f6471);
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }

    .status strong {
      color: var(--tg-theme-text-color, #1f2330);
    }

    .status.error {
      background-color: var(--danger-surface-color, rgba(234, 84, 90, 0.08));
      border-color: var(--danger-border-color, rgba(234, 84, 90, 0.25));
      color: var(--tg-theme-destructive-text-color, #c7363c);
    }

    .products {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border: 1px solid var(--card-border-color, rgba(31, 35, 48, 0.08));
    }

    .card-info {
      flex: 1;
      min-width: 0;
    }

    .card-info h2 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .card-info p {
      margin: 0;
      font-size: 13px;
      color: var(--tg-theme-hint-color, #5f6471);
    }

    .card-info .price {
      margin-top: 10px;
      font-weight: 600;
      font-size: 14px;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .quantity {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity button {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: none;
      background-color: var(--tg-theme-button-color, #1a68d1);
      color: var(--tg-theme-button-text-color, #ffffff);
      font-size: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease, opacity 0.15s ease;
      touch-action: manipulation;
    }

    .quantity button:disabled {
      opacity: 0.35;
      cursor: default;
    }

    .quantity button:not(:disabled):active {
      background-color: var(--button-active-color, #1555aa);
    }

    .quantity-value {
      min-width: 26px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .summary {
      padding: 14px 16px;
      border-radius: 14px;
      background-color: var(--tg-theme-secondary-bg-color, #ffffff);
      border: 1px solid var(--surface-border-color, rgba(31, 35, 48, 0.08));
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
      color: var(--tg-theme-text-color, #1f2330);
    }

    .submit {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background-color: var(--tg-theme-button-color, #1a68d1);
      color: var(--tg-theme-button-text-color, #ffffff);
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .submit:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      padding: 14px 20px;
      border-radius: 14px;
      background: var(--toast-bg-color, rgba(17, 24, 35, 0.92));
      color: var(--tg-theme-button-text-color, #ffffff);
      box-shadow: 0 8px 24px rgba(9, 17, 33, 0.28);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
      font-size: 13px;
    }

    .toast.visible {
      opacity: 0.94;
    }

    button:focus-visible {
      outline: 2px solid var(--tg-theme-link-color, #1a68d1);
      outline-offset: 2px;
    }

    #debug-panel {
      display: none;
      font-size: 13px;
      white-space: pre-wrap;
    }

    body[data-debug="true"] #debug-panel {
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --surface-border-color: rgba(255, 255, 255, 0.04);
        --card-border-color: rgba(255, 255, 255, 0.04);
        --button-active-color: #416fda;
        --danger-surface-color: rgba(255, 156, 162, 0.12);
        --danger-border-color: rgba(255, 156, 162, 0.32);
        --toast-bg-color: rgba(8, 13, 23, 0.92);
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <h1>Мій Телеграм-магазин</h1>
    <div id="status" class="status"></div>

    <section class="products" id="products"></section>
    <div class="summary">
      <span>До сплати</span>
      <span id="total">0 ₴</span>
    </div>
    <button id="submit" class="submit" type="button" disabled>Відправити замовлення</button>
    <section id="debug-panel" class="status error" hidden></section>
  </main>
  <div id="toast" class="toast" role="status"></div>

  <script>
    const PRODUCTS = [
      { id: "pizza_margherita", name: "Піца Маргарита", description: "Томатний соус, моцарела, базилік", price: 220 },
      { id: "pizza_pepperoni", name: "Піца Пепероні", description: "Салямі, томатний соус, сир", price: 260 },
      { id: "burger_classic", name: "Бургер Класичний", description: "Яловичина, сир чеддер, бекон", price: 210 }
    ];

    const ORDER_ENDPOINT = "https://api.sendpulse.com/events/id/230b72780acd4255ecb438b57968e5f6/264992";

    const statusEl = document.getElementById("status");
    const productsEl = document.getElementById("products");
    const totalEl = document.getElementById("total");
    const submitButton = document.getElementById("submit");
    const toastEl = document.getElementById("toast");
    const debugPanelEl = document.getElementById("debug-panel");
    const tg = window.Telegram?.WebApp || null;

    const urlParams = new URLSearchParams(window.location.search);
    const contactId = urlParams.get("contact_id");
    const debugMode = urlParams.get("debug") === "1";

    const themeState = {
      buttonColor: null,
      buttonTextColor: null
    };

    const state = {
      contactId,
      quantities: Object.fromEntries(PRODUCTS.map(product => [product.id, 0])),
      total: 0,
      submitting: false,
      statusMessage: "",
      statusIsError: false
    };

    setupTelegramExperience();

    function renderStatus() {
      if (!state.contactId) {
        statusEl.textContent = "contact_id не переданий у параметрах URL. Перевірте налаштування кнопки в боті.";
        state.statusIsError = true;
        statusEl.classList.add("error");
        submitButton.disabled = true;
        return;
      }

      const baseText = `Підписник: ${state.contactId}`;
      const extra = state.statusMessage ? `\n${state.statusMessage}` : "";
      statusEl.textContent = baseText + extra;
      statusEl.classList.toggle("error", state.statusIsError);
    }

    function renderProducts() {
      productsEl.innerHTML = "";

      PRODUCTS.forEach(product => {
        const card = document.createElement("article");
        card.className = "card";

        const info = document.createElement("div");
        info.className = "card-info";
        info.innerHTML = `
          <h2>${product.name}</h2>
          <p>${product.description}</p>
          <div class="price">${product.price} ₴</div>
        `;

        const quantityControls = document.createElement("div");
        quantityControls.className = "quantity";

        const minusButton = document.createElement("button");
        minusButton.type = "button";
        minusButton.textContent = "−";
        minusButton.dataset.productId = product.id;
        minusButton.setAttribute("aria-label", `Зменшити кількість для ${product.name}`);
        minusButton.addEventListener("click", () => updateQuantity(product.id, state.quantities[product.id] - 1));

        const quantityValue = document.createElement("span");
        quantityValue.className = "quantity-value";
        quantityValue.dataset.productId = product.id;
        quantityValue.textContent = state.quantities[product.id];

        const plusButton = document.createElement("button");
        plusButton.type = "button";
        plusButton.textContent = "+";
        plusButton.dataset.productId = product.id;
        plusButton.setAttribute("aria-label", `Збільшити кількість для ${product.name}`);
        plusButton.addEventListener("click", () => updateQuantity(product.id, state.quantities[product.id] + 1));

        quantityControls.append(minusButton, quantityValue, plusButton);

        card.append(info, quantityControls);

        productsEl.append(card);
      });
    }

    function updateQuantity(productId, nextValue) {
      const value = Math.max(0, nextValue);
      state.quantities[productId] = value;
      state.total = calculateTotal();
      renderTotals();
      updateSubmitState();
      syncQuantities();
    }

    function calculateTotal() {
      return PRODUCTS.reduce((sum, product) => {
        return sum + state.quantities[product.id] * product.price;
      }, 0);
    }

    function renderTotals() {
      totalEl.textContent = `${state.total} ₴`;
    }

    function updateSubmitState() {
      const hasItems = PRODUCTS.some(product => state.quantities[product.id] > 0);
      const ready = hasItems && Boolean(state.contactId);
      const disabled = !ready || state.submitting;
      submitButton.disabled = disabled;
      submitButton.textContent = state.submitting ? "Відправка..." : "Відправити замовлення";

      if (tg) {
        if (!ready) {
          tg.MainButton.hideProgress?.();
          tg.MainButton.hide();
        } else {
          const { color, textColor } = getButtonColors();
          tg.MainButton.setParams({
            text: state.submitting ? "Відправка..." : "Відправити замовлення",
            color,
            text_color: textColor
          });
          if (state.submitting) {
            tg.MainButton.showProgress?.();
          } else {
            tg.MainButton.hideProgress?.();
          }
          tg.MainButton.show();
        }
      }
    }

    function syncQuantities() {
      const values = productsEl.querySelectorAll(".quantity-value[data-product-id]");
      values.forEach(valueEl => {
        const productId = valueEl.dataset.productId;
        valueEl.textContent = state.quantities[productId];
      });

      const minusButtons = productsEl.querySelectorAll(".quantity button[data-product-id]");
      minusButtons.forEach(button => {
        const productId = button.dataset.productId;
        button.disabled = state.quantities[productId] === 0;
      });
    }

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add("visible");
      setTimeout(() => toastEl.classList.remove("visible"), 2600);
    }

    async function submitOrder() {
      if (state.submitting) return;
      if (submitButton.disabled && !tg) return;

      state.submitting = true;
      updateSubmitState();
      if (tg) {
        tg.HapticFeedback?.impactOccurred?.("medium");
      }

      const items = PRODUCTS
        .filter(product => state.quantities[product.id] > 0)
        .map(product => ({
          id: product.id,
          name: product.name,
          quantity: state.quantities[product.id],
          price: product.price,
          subtotal: state.quantities[product.id] * product.price
        }));

      const payload = {
        chatbots_subscriber_id: state.contactId,
        order_items: items,
        total_amount: state.total,
        currency: "UAH",
        created_at: new Date().toISOString(),
        source: "telegram_web_app",
        notes: "Demo замовлення"
      };

      try {
        logDebug([
          "POST " + ORDER_ENDPOINT,
          "Headers:",
          JSON.stringify({
            "Content-Type": "application/json"
          }, null, 2),
          "Payload:",
          JSON.stringify(payload, null, 2)
        ].join("\n"));

        const response = await fetch(ORDER_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const bodyText = await response.text();
          throw new Error(`Помилка API: ${response.status} ${response.statusText || ""} — ${bodyText}`);
        }

        logDebug("Відповідь API: успіх");
        updateStatusMessage("Замовлення відправлено успішно ✅", false);
        showToast("Замовлення відправлено ✅");
        if (tg) {
          tg.HapticFeedback?.notificationOccurred?.("success");
        }
        resetOrder();
        if (tg && !debugMode) {
          tg.MainButton.hideProgress?.();
          tg.MainButton.hide();
          setTimeout(() => {
            try {
              tg.close();
            } catch (closeError) {
              logDebug("Не вдалося закрити WebApp: " + closeError);
            }
          }, 600);
        }
      } catch (error) {
        console.error(error);
        logDebug("Помилка: " + (error && error.message ? error.message : error));
        updateStatusMessage("Не вдалося відправити замовлення. " + (error && error.message ? error.message : ""), true);
        showToast("Не вдалося відправити замовлення");
        if (tg) {
          tg.HapticFeedback?.notificationOccurred?.("error");
        }
      } finally {
        state.submitting = false;
        updateSubmitState();
      }
    }

    function resetOrder() {
      PRODUCTS.forEach(product => {
        state.quantities[product.id] = 0;
      });
      state.total = 0;
      syncQuantities();
      renderTotals();
    }

    submitButton.addEventListener("click", submitOrder);

    renderStatus();
    renderProducts();
    renderTotals();
    updateSubmitState();
    syncQuantities();

    if (debugMode) {
      debugPanelEl.hidden = false;
      debugPanelEl.textContent = "DEBUG MODE: лог запитів з'явиться нижче.";
      document.body.dataset.debug = "true";
    } else {
      delete document.body.dataset.debug;
    }

    function logDebug(message) {
      if (!debugMode) return;
      const time = new Date().toLocaleTimeString();
      const existing = debugPanelEl.textContent ? debugPanelEl.textContent + "\n\n" : "";
      debugPanelEl.textContent = existing + `[${time}] ${message}`;
    }

    function updateStatusMessage(message, isError) {
      state.statusMessage = message;
      state.statusIsError = isError;
      renderStatus();
    }

    function setupTelegramExperience() {
      if (!tg) return;

      tg.ready();
      tg.expand?.();
      applyThemeParams(tg.themeParams || {});
      tg.onEvent?.("themeChanged", () => {
        applyThemeParams(tg.themeParams || {});
        updateSubmitState();
      });

      submitButton.style.display = "none";
      submitButton.setAttribute("aria-hidden", "true");
      submitButton.tabIndex = -1;

      tg.MainButton.setText("Відправити замовлення");
      tg.MainButton.onClick(submitOrder);
      tg.MainButton.hide();

      if (tg.colorScheme) {
        document.documentElement.style.colorScheme = tg.colorScheme;
      }

      logDebug("Telegram WebApp API доступний, нативні елементи активовано.");
    }

    function applyThemeParams(params) {
      const root = document.documentElement;
      const map = {
        bg_color: "--tg-theme-bg-color",
        text_color: "--tg-theme-text-color",
        hint_color: "--tg-theme-hint-color",
        link_color: "--tg-theme-link-color",
        button_color: "--tg-theme-button-color",
        button_text_color: "--tg-theme-button-text-color",
        secondary_bg_color: "--tg-theme-secondary-bg-color",
        destructive_text_color: "--tg-theme-destructive-text-color"
      };

      Object.entries(map).forEach(([key, cssVar]) => {
        if (params[key]) {
          root.style.setProperty(cssVar, params[key]);
        }
      });

      if (params.secondary_bg_color) {
        const stroke = adjustColor(params.secondary_bg_color, -12) || "rgba(31, 35, 48, 0.08)";
        root.style.setProperty("--card-border-color", stroke);
        root.style.setProperty("--surface-border-color", stroke);
      }

      if (params.bg_color) {
        const toastColor = adjustColor(params.bg_color, -32);
        if (toastColor) {
          root.style.setProperty("--toast-bg-color", toastColor);
        }
      }

      const computed = getComputedStyle(root);
      themeState.buttonColor = (params.button_color || computed.getPropertyValue("--tg-theme-button-color")).trim();
      themeState.buttonTextColor = (params.button_text_color || computed.getPropertyValue("--tg-theme-button-text-color")).trim();

      const active = adjustColor(themeState.buttonColor, -18);
      if (active) {
        root.style.setProperty("--button-active-color", active);
      }
    }

    function getButtonColors() {
      const computed = getComputedStyle(document.documentElement);
      const color = (themeState.buttonColor || computed.getPropertyValue("--tg-theme-button-color") || "#1a68d1").trim();
      const textColor = (themeState.buttonTextColor || computed.getPropertyValue("--tg-theme-button-text-color") || "#ffffff").trim();
      return { color, textColor };
    }

    function adjustColor(hexColor, percent) {
      const hexMatch = /^#([0-9a-f]{6})$/i.exec(hexColor || "");
      if (!hexMatch) return null;
      const num = parseInt(hexMatch[1], 16);
      let r = (num >> 16) & 0xff;
      let g = (num >> 8) & 0xff;
      let b = num & 0xff;

      const factor = (100 + percent) / 100;
      r = Math.min(255, Math.max(0, Math.round(r * factor)));
      g = Math.min(255, Math.max(0, Math.round(g * factor)));
      b = Math.min(255, Math.max(0, Math.round(b * factor)));

      const toHex = value => value.toString(16).padStart(2, "0");
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
  </script>
</body>
</html>
